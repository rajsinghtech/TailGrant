name: Restart TailGrant

on:
  push:
    branches: ["main"]
    paths:
      - "kustomization/**"
  workflow_run:
    workflows: ["Build & Push TailGrant Image"]
    types: [completed]
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: restart-tailgrant
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  restart:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Install Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: TbqNGJkY5611CNTRL-kz4CwX2LK721CNTRL
          audience: api.tailscale.com/TbqNGJkY5611CNTRL-kz4CwX2LK721CNTRL
          tags: tag:ci
          args: --accept-dns

      - name: Reconcile and restart
        run: |
          sudo tailscale configure kubeconfig ottawa-k8s-operator.keiretsu.ts.net
          sudo env "PATH=$PATH" flux reconcile kustomization tailgrant -n flux-system --with-source
          sudo kubectl rollout restart deployment tailgrant-server -n tailgrant
          sudo kubectl rollout restart deployment tailgrant-worker -n tailgrant
          sudo kubectl rollout status deployment tailgrant-server -n tailgrant --timeout=120s
          sudo kubectl rollout status deployment tailgrant-worker -n tailgrant --timeout=120s
