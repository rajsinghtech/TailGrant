<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TailGrant</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%236c8cff'/><path d='M16 6l8 4.5v7c0 4.7-3.4 9.1-8 10.5-4.6-1.4-8-5.8-8-10.5v-7L16 6z' fill='%230f1117' opacity='.9'/><path d='M16 8.5l6 3.4v5.6c0 3.6-2.6 7-6 8.1-3.4-1.1-6-4.5-6-8.1v-5.6l6-3.4z' fill='none' stroke='%236c8cff' stroke-width='1.2'/><circle cx='16' cy='17' r='2.5' fill='%236c8cff'/><rect x='15' y='19' width='2' height='3' rx='1' fill='%236c8cff'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0c10;
  --surface: #13161d;
  --surface-raised: #1a1e28;
  --border: #232836;
  --border-hover: #353b4d;
  --text: #e2e5f0;
  --text-secondary: #9096ab;
  --text-dim: #5c6278;
  --accent: #6c8cff;
  --accent-glow: rgba(108,140,255,0.15);
  --accent-hover: #8aa4ff;
  --green: #34d399;
  --green-dim: rgba(52,211,153,0.12);
  --yellow: #fbbf24;
  --yellow-dim: rgba(251,191,36,0.12);
  --red: #f87171;
  --red-dim: rgba(248,113,113,0.12);
  --orange: #fb923c;
  --orange-dim: rgba(251,146,60,0.12);
  --font: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'IBM Plex Mono', 'SF Mono', monospace;
  --radius: 10px;
  --radius-lg: 14px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

/* Noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

.app {
  position: relative;
  z-index: 1;
  max-width: 1000px;
  margin: 0 auto;
  padding: 32px 24px 64px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo {
  width: 36px;
  height: 36px;
  background: var(--accent);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo svg { width: 20px; height: 20px; }

.header-title {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.header-tag {
  font-size: 11px;
  font-weight: 500;
  color: var(--accent);
  background: var(--accent-glow);
  padding: 2px 8px;
  border-radius: 4px;
  margin-left: 10px;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}

.user-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 6px 14px;
  border-radius: 20px;
}

.user-badge .dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--green);
}

/* Section headers */
.section-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* Grant type cards */
.grant-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}

.grant-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 18px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.grant-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  border-radius: 3px 0 0 3px;
}

.grant-card[data-risk="low"]::before { background: var(--green); }
.grant-card[data-risk="medium"]::before { background: var(--yellow); }
.grant-card[data-risk="high"]::before { background: var(--red); }

.grant-card:hover {
  border-color: var(--border-hover);
  background: var(--surface-raised);
  transform: translateY(-1px);
}

.grant-card.selected {
  border-color: var(--accent);
  background: var(--surface-raised);
  box-shadow: 0 0 0 1px var(--accent), 0 4px 24px rgba(108,140,255,0.08);
}

.grant-card-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 6px;
}

.grant-card-name {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: -0.01em;
}

.grant-card-action {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 2px 7px;
  border-radius: 4px;
  white-space: nowrap;
  flex-shrink: 0;
}

.action-tag { background: var(--accent-glow); color: var(--accent); }
.action-user_role { background: var(--orange-dim); color: var(--orange); }
.action-user_restore { background: var(--yellow-dim); color: var(--yellow); }

.grant-card-desc {
  font-size: 12.5px;
  color: var(--text-secondary);
  margin-bottom: 10px;
  line-height: 1.5;
}

.grant-card-meta {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.meta-chip {
  font-size: 11px;
  font-family: var(--mono);
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 4px;
}

.meta-chip svg {
  width: 12px;
  height: 12px;
  opacity: 0.6;
}

/* Request form panel */
.request-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1),
              opacity 0.25s ease,
              margin 0.35s ease;
  opacity: 0;
  margin-bottom: 0;
}

.request-panel.open {
  max-height: 600px;
  opacity: 1;
  margin-bottom: 12px;
}

.request-form-inner {
  background: var(--surface);
  border: 1px solid var(--accent);
  border-radius: var(--radius);
  padding: 24px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0 20px;
}

.form-header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
  padding-bottom: 14px;
  border-bottom: 1px solid var(--border);
}

.form-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-header h3 {
  font-size: 14px;
  font-weight: 600;
}

.form-header .selected-type {
  font-size: 12px;
  color: var(--accent);
  font-family: var(--mono);
  font-weight: 500;
}

.form-close {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.15s;
}

.form-close:hover {
  background: var(--surface-raised);
  border-color: var(--border-hover);
  color: var(--text);
}

.form-group {
  margin-bottom: 14px;
}

.form-group.full {
  grid-column: 1 / -1;
}

.form-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-dim);
  margin-bottom: 6px;
}

.form-select,
.form-input,
.form-textarea {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 13px;
  font-family: var(--font);
  transition: border-color 0.15s;
  appearance: none;
}

.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235c6278' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
}

.form-select:focus,
.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.form-textarea {
  resize: vertical;
  min-height: 64px;
  line-height: 1.5;
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 10px;
  margin-top: 4px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-submit {
  background: var(--accent);
  color: #fff;
  flex: 1;
}

.btn-submit:hover {
  background: var(--accent-hover);
  box-shadow: 0 4px 16px rgba(108,140,255,0.25);
}

.btn-submit:active { transform: scale(0.98); }

/* Grants section */
.grants-section {
  margin-top: 40px;
}

.grants-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.grant-row {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 18px;
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr) minmax(0, 1fr) auto auto;
  gap: 16px;
  align-items: center;
  transition: border-color 0.15s;
}

.grant-row:hover { border-color: var(--border-hover); }

.grant-row-main {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.grant-row-type {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.grant-row-id {
  font-size: 11px;
  font-family: var(--mono);
  color: var(--text-dim);
}

.grant-row-target {
  font-size: 12.5px;
  font-family: var(--mono);
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.grant-row-requester {
  font-size: 12.5px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  white-space: nowrap;
}

.badge::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.badge-pending_approval { background: var(--yellow-dim); color: var(--yellow); }
.badge-pending_approval::before { background: var(--yellow); }
.badge-active { background: var(--green-dim); color: var(--green); }
.badge-active::before { background: var(--green); animation: pulse 2s infinite; }
.badge-expired { background: rgba(92,98,120,0.15); color: var(--text-dim); }
.badge-expired::before { background: var(--text-dim); }
.badge-revoked { background: var(--red-dim); color: var(--red); }
.badge-revoked::before { background: var(--red); }
.badge-denied { background: var(--red-dim); color: var(--red); }
.badge-denied::before { background: var(--red); }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.grant-row-actions {
  display: flex;
  gap: 6px;
}

.btn-sm {
  padding: 5px 12px;
  font-size: 11px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-family: var(--font);
  transition: all 0.15s;
}

.btn-approve { background: var(--green-dim); color: var(--green); }
.btn-approve:hover { background: var(--green); color: #000; }
.btn-deny { background: var(--red-dim); color: var(--red); }
.btn-deny:hover { background: var(--red); color: #fff; }
.btn-revoke { background: var(--red-dim); color: var(--red); }
.btn-revoke:hover { background: var(--red); color: #fff; }

.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-dim);
  font-size: 13px;
  background: var(--surface);
  border: 1px dashed var(--border);
  border-radius: var(--radius);
}

.empty-state-icon {
  font-size: 28px;
  margin-bottom: 8px;
  opacity: 0.4;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  font-family: var(--font);
  color: #fff;
  z-index: 1000;
  animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.toast-success { background: var(--green); color: #000; }
.toast-error { background: var(--red); }

@keyframes toastIn {
  from { opacity: 0; transform: translateY(12px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Loading shimmer */
.loading-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 18px;
  height: 100px;
  position: relative;
  overflow: hidden;
}

.loading-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Responsive */
@media (max-width: 768px) {
  .app { padding: 20px 16px 48px; }
  .grant-cards { grid-template-columns: 1fr; }
  .request-form-inner { grid-template-columns: 1fr; }
  .grant-row {
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .grant-row-actions { grid-column: 1 / -1; }
}

@media (max-width: 480px) {
  .header { flex-direction: column; gap: 12px; align-items: flex-start; }
  .grant-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0a0c10" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L3 7v6c0 5.5 3.8 10.7 9 12 5.2-1.3 9-6.5 9-12V7l-9-5z"/>
        </svg>
      </div>
      <span class="header-title">TailGrant</span>
      <span class="header-tag">JIT</span>
    </div>
    <div class="user-badge" id="user-info">
      <span class="dot"></span>
      <span>loading...</span>
    </div>
  </div>

  <div class="section-label">Request Access</div>
  <div class="grant-cards" id="grant-cards">
    <div class="loading-card"></div>
    <div class="loading-card"></div>
    <div class="loading-card"></div>
  </div>

  <div class="request-panel" id="request-panel">
    <form class="request-form-inner" id="request-form">
      <div class="form-header">
        <div class="form-header-left">
          <h3>New Request</h3>
          <span class="selected-type" id="form-selected-type"></span>
        </div>
        <button type="button" class="form-close" id="form-close">&times;</button>
      </div>

      <div class="form-group" id="target-device-wrap">
        <label class="form-label" for="target-node">Target Device</label>
        <select class="form-select" id="target-node">
          <option value="">Select device...</option>
        </select>
      </div>

      <div class="form-group" id="target-user-wrap" style="display:none">
        <label class="form-label" for="target-user">Target User</label>
        <select class="form-select" id="target-user">
          <option value="">Select user...</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="duration">Duration</label>
        <select class="form-select" id="duration" required>
          <option value="30m">30 minutes</option>
          <option value="1h" selected>1 hour</option>
          <option value="2h">2 hours</option>
          <option value="4h">4 hours</option>
          <option value="8h">8 hours</option>
        </select>
      </div>

      <div class="form-group full">
        <label class="form-label" for="reason">Reason</label>
        <textarea class="form-textarea" id="reason" placeholder="Why do you need this access?" required></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-submit">Request Access</button>
      </div>
    </form>
  </div>

  <div class="grants-section">
    <div class="section-label">Grants</div>
    <div id="grants-wrap">
      <div class="empty-state">
        <div class="empty-state-icon">&#9711;</div>
        No grants found
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api';
let grants = [];
let deviceMap = {};
let userMap = {};
let grantTypeMap = {};
let grantTypeList = [];
let selectedGrantType = null;

async function api(path, opts) {
  const res = await fetch(API + path, opts);
  if (!res.ok) {
    const body = await res.text().catch(() => '');
    let msg = res.statusText;
    if (body) {
      try { msg = JSON.parse(body).error || body; } catch { msg = body; }
    }
    throw new Error(msg);
  }
  if (res.status === 204) return null;
  return res.json();
}

function toast(msg, type) {
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function isUserAction(gtName) {
  const gt = grantTypeMap[gtName];
  if (!gt) return false;
  const action = gt.action || 'tag';
  return action === 'user_role' || action === 'user_restore';
}

function formatDuration(d) {
  if (!d) return '';
  const ns = parseInt(d);
  // maxDuration comes as nanoseconds string from Go's time.Duration JSON
  if (ns > 1000000000) {
    const hours = Math.floor(ns / 3600000000000);
    const mins = Math.floor((ns % 3600000000000) / 60000000000);
    if (hours > 0 && mins > 0) return hours + 'h ' + mins + 'm';
    if (hours > 0) return hours + 'h';
    return mins + 'm';
  }
  return d;
}

function relativeTime(iso) {
  if (!iso || iso === '0001-01-01T00:00:00Z') return '';
  const date = new Date(iso);
  const now = new Date();
  const diff = date - now;
  if (diff <= 0) return 'expired';
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(mins / 60);
  if (hours > 0) return hours + 'h ' + (mins % 60) + 'm left';
  return mins + 'm left';
}

function actionLabel(action) {
  if (action === 'user_role') return 'Role';
  if (action === 'user_restore') return 'Restore';
  return 'Tag';
}

function riskLabel(level) {
  if (typeof level === 'number') {
    if (level === 0) return 'low';
    if (level === 1) return 'medium';
    return 'high';
  }
  return level || 'low';
}

// Render grant type cards
function renderGrantTypes(types) {
  const container = document.getElementById('grant-cards');
  container.innerHTML = '';
  grantTypeMap = {};
  grantTypeList = types;

  types.forEach(t => {
    grantTypeMap[t.name] = t;
    const action = t.action || 'tag';
    const risk = riskLabel(t.riskLevel);

    const card = document.createElement('div');
    card.className = 'grant-card';
    card.dataset.risk = risk;
    card.dataset.name = t.name;

    let metaHTML = '';
    metaHTML += '<span class="meta-chip"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>' + esc(formatDuration(t.maxDuration)) + '</span>';

    if (action === 'tag') {
      if (t.tags && t.tags.length) {
        metaHTML += '<span class="meta-chip">' + esc(t.tags.join(', ')) + '</span>';
      }
    } else if (action === 'user_role') {
      metaHTML += '<span class="meta-chip">' + esc((t.userAction || {}).role || '') + '</span>';
    }

    card.innerHTML =
      '<div class="grant-card-top">' +
        '<span class="grant-card-name">' + esc(t.name) + '</span>' +
        '<span class="grant-card-action action-' + esc(action) + '">' + esc(actionLabel(action)) + '</span>' +
      '</div>' +
      '<div class="grant-card-desc">' + esc(t.description) + '</div>' +
      '<div class="grant-card-meta">' + metaHTML + '</div>';

    card.addEventListener('click', () => selectGrantType(t.name));
    container.appendChild(card);
  });
}

function selectGrantType(name) {
  const panel = document.getElementById('request-panel');
  const cards = document.querySelectorAll('.grant-card');

  // Deselect if clicking same card
  if (selectedGrantType === name) {
    deselectGrantType();
    return;
  }

  selectedGrantType = name;
  cards.forEach(c => c.classList.toggle('selected', c.dataset.name === name));

  document.getElementById('form-selected-type').textContent = name;

  const userGrant = isUserAction(name);
  document.getElementById('target-device-wrap').style.display = userGrant ? 'none' : '';
  document.getElementById('target-user-wrap').style.display = userGrant ? '' : 'none';

  panel.classList.add('open');

  // Scroll form into view
  setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

function deselectGrantType() {
  selectedGrantType = null;
  document.querySelectorAll('.grant-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('request-panel').classList.remove('open');
}

document.getElementById('form-close').addEventListener('click', deselectGrantType);

document.getElementById('request-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!selectedGrantType) return;

  const userGrant = isUserAction(selectedGrantType);
  const payload = {
    grantTypeName: selectedGrantType,
    duration: document.getElementById('duration').value,
    reason: document.getElementById('reason').value,
  };
  if (userGrant) {
    payload.targetUserID = document.getElementById('target-user').value;
  } else {
    payload.targetNodeID = document.getElementById('target-node').value;
  }

  try {
    await api('/grants', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    toast('Grant requested', 'success');
    document.getElementById('request-form').reset();
    deselectGrantType();
    loadGrants();
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
});

function renderGrants(data) {
  const wrap = document.getElementById('grants-wrap');
  if (!data || data.length === 0) {
    wrap.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#9711;</div>No grants found</div>';
    return;
  }

  let html = '<div class="grants-list">';
  data.forEach(g => {
    const req = g.request || {};
    let target = '';
    if (req.targetUserID) {
      target = userMap[req.targetUserID] || req.targetUserID;
    } else {
      target = deviceMap[req.targetNodeID] || req.targetNodeID || '';
    }

    const status = g.status || 'unknown';
    const expires = status === 'active' ? relativeTime(g.expiresAt) : '';

    html += '<div class="grant-row">' +
      '<div class="grant-row-main">' +
        '<div class="grant-row-type">' + esc(req.grantTypeName || '') + '</div>' +
        '<div class="grant-row-id">' + esc((req.id || '').slice(0, 12)) + (expires ? ' &middot; ' + esc(expires) : '') + '</div>' +
      '</div>' +
      '<div class="grant-row-target">' + esc(target) + '</div>' +
      '<div class="grant-row-requester">' + esc(req.requester || '') + '</div>' +
      '<div><span class="badge badge-' + esc(status) + '">' + esc(status.replace('_', ' ')) + '</span></div>' +
      '<div class="grant-row-actions">' + grantActions(g) + '</div>' +
    '</div>';
  });

  html += '</div>';
  wrap.innerHTML = html;
}

function grantActions(g) {
  const id = (g.request || {}).id;
  if (!id) return '';
  if (g.status === 'pending_approval') {
    return '<button class="btn-sm btn-approve" onclick="approveGrant(\'' + esc(id) + '\')">Approve</button>' +
           '<button class="btn-sm btn-deny" onclick="denyGrant(\'' + esc(id) + '\')">Deny</button>';
  }
  if (g.status === 'active') {
    return '<button class="btn-sm btn-revoke" onclick="revokeGrant(\'' + esc(id) + '\')">Revoke</button>';
  }
  return '';
}

async function approveGrant(id) {
  try {
    await api('/grants/' + id + '/approve', { method: 'POST' });
    toast('Grant approved', 'success');
    loadGrants();
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
}

async function denyGrant(id) {
  try {
    await api('/grants/' + id + '/deny', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: '' }),
    });
    toast('Grant denied', 'success');
    loadGrants();
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
}

async function revokeGrant(id) {
  try {
    await api('/grants/' + id + '/revoke', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: '' }),
    });
    toast('Grant revoked', 'success');
    loadGrants();
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
}

async function loadGrantTypes() {
  try {
    const types = await api('/grant-types');
    renderGrantTypes(types || []);
  } catch (e) {
    console.error('failed to load grant types', e);
  }
}

async function loadGrants() {
  try {
    const data = await api('/grants');
    grants = data || [];
    renderGrants(grants);
  } catch (e) {
    console.error('failed to load grants', e);
  }
}

async function loadUser() {
  try {
    const info = await api('/whoami');
    const el = document.getElementById('user-info');
    el.innerHTML = '<span class="dot"></span><span>' + esc(info.login || info.name || 'unknown') + '</span>';
  } catch {
    const el = document.getElementById('user-info');
    el.innerHTML = '<span class="dot" style="background:var(--red)"></span><span>not authenticated</span>';
  }
}

async function loadDevices() {
  try {
    const devices = await api('/devices');
    const sel = document.getElementById('target-node');
    sel.innerHTML = '<option value="">Select device...</option>';
    (devices || [])
      .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
      .forEach(d => {
        deviceMap[d.nodeId] = d.hostname || d.name || d.nodeId;
        const opt = document.createElement('option');
        opt.value = d.nodeId;
        opt.textContent = (d.hostname || d.name || d.nodeId) + ' (' + (d.addresses || [])[0] + ')';
        sel.appendChild(opt);
      });
  } catch (e) {
    console.error('failed to load devices', e);
  }
}

async function loadUsers() {
  try {
    const users = await api('/users');
    const sel = document.getElementById('target-user');
    sel.innerHTML = '<option value="">Select user...</option>';
    (users || [])
      .sort((a, b) => (a.loginName || '').localeCompare(b.loginName || ''))
      .forEach(u => {
        userMap[u.id] = u.loginName || u.displayName || u.id;
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.displayName || u.loginName || u.id) + ' (' + (u.loginName || '') + ')';
        sel.appendChild(opt);
      });
  } catch (e) {
    console.error('failed to load users', e);
  }
}

// Init
loadUser();
loadGrantTypes();
loadDevices();
loadUsers();
loadGrants();
setInterval(loadGrants, 5000);
</script>
</body>
</html>
